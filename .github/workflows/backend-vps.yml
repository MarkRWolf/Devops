name: Build & Deploy - BACKEND - VPS
on:
  push:
    branches:
      - ghbackend

jobs:
  backend:
    runs-on:
      - self-hosted
      - Linux
      - X64
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute commit tag
        run: echo "SHORT_SHA=$(git rev-parse --short=12 HEAD)" >> $GITHUB_ENV

      - name: Build report image and extract test results
        run: |
          rm -rf ./test-report-out

          nerdctl --address /run/k3s/containerd/containerd.sock -n k8s.io build \
            -f Devops/Dockerfile.jenkins \
            --target report \
            --output type=local,dest=./test-report-out \
            .

          ls -l test-report-out
          test -f test-report-out/test-results.xml

      - name: Upload backend test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results-${{ env.SHORT_SHA }}
          path: test-report-out/test-results.xml

      - name: Build backend runtime image
        run: |
          nerdctl --address /run/k3s/containerd/containerd.sock -n k8s.io build \
            -f Devops/Dockerfile.jenkins \
            --target runtime \
            -t backend:$SHORT_SHA .
          nerdctl --address /run/k3s/containerd/containerd.sock -n k8s.io tag backend:$SHORT_SHA backend:local

      - name: Deploy backend to k3s
        run: |
          sudo k3s kubectl set image deploy/backend backend=backend:$SHORT_SHA
          sudo k3s kubectl rollout status deploy/backend -w
