name: Build & Deploy - BACKEND - VPS

on:
  push:
    branches:
      - ghbackend

jobs:
  backend:
    runs-on:
      - self-hosted
      - Linux
      - X64
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          clean: false

      - name: Compute commit tag
        run: echo "SHORT_SHA=$(git rev-parse --short=12 HEAD)" >> $GITHUB_ENV

      - name: Build report image and extract test results
        run: |
          sudo /usr/local/bin/nerdctl --address /run/k3s/containerd/containerd.sock -n k8s.io build \
            -f Devops/Dockerfile.jenkins \
            --target report \
            --output type=local,dest=/opt/ci-test-reports/backend \
            .

          ls -l /opt/ci-test-reports/backend
          test -f /opt/ci-test-reports/backend/test-results.xml

      - name: Upload backend test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results-${{ env.SHORT_SHA }}
          path: /opt/ci-test-reports/backend/test-results.xml

      - name: Build backend runtime image
        run: |
          sudo /usr/local/bin/nerdctl --address /run/k3s/containerd/containerd.sock -n k8s.io build \
            -f Devops/Dockerfile.jenkins \
            --target runtime \
            -t backend:$SHORT_SHA .
          sudo /usr/local/bin/nerdctl --address /run/k3s/containerd/containerd.sock -n k8s.io tag backend:$SHORT_SHA backend:local

      - name: Deploy backend to k3s
        run: |
          sudo /usr/local/bin/k3s kubectl set image deploy/backend backend=backend:$SHORT_SHA
          sudo /usr/local/bin/k3s kubectl rollout status deploy/backend -w
